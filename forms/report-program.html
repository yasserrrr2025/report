<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>تقرير تنفيذ برنامج —مدرسة عماد الدين زنكي المتوسطة</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#64748b; --line:#e6eef2;
  --paper:#ffffff; --bg:#f6f8fb;
  --accent:#2f7f79; --accentDeep:#0e3b46; --footer:#0e3b46;
  --base:14px; --title:19px; --name:17px;
  --gap-top:4mm; --gap-mid:4mm; --gap-gallery:4.5mm; --gap-sign:5mm;
}
*{box-sizing:border-box}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font-family:"Tajawal",system-ui,sans-serif; font-size:var(--base); line-height:1.6;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  text-rendering:optimizeLegibility;
}

/* ورقة */
.sheet{
  width:210mm; height:297mm; margin:12px auto; background:var(--paper);
  border:1px solid #e5e7eb; box-shadow:0 10px 28px rgba(0,0,0,.08);
  display:grid; grid-template-rows:30mm auto 6mm; overflow:hidden; position:relative;
}
.sheet:before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(1200px 400px at 50% -10%, rgba(47,127,121,.10), transparent 60%);
}

/* الهيدر + زر PDF داخل الهيدر */
.header-img{position:relative; height:30mm; overflow:hidden; background:var(--accentDeep)}
.header-img img{width:100%; height:100%; object-fit:cover; display:block}
.header-fallback{position:absolute; inset:0; background:linear-gradient(90deg,#0b7e88,#15a3ad); display:none}

/* نص الهيدر في الوسط (قابل للتعديل) */
.header-center{
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center; color:#fff;
  font-weight:800; font-size:18px; line-height:1.6;
  z-index:10;
}

/* زر PDF داخل الهيدر (لا يُطبع) */
.header-action{
  position:absolute; top:10px; left:12px; z-index:20;
}
.pdf-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 14px; border-radius:14px;
  background:linear-gradient(180deg, var(--accent), var(--accentDeep));
  color:#fff; font-weight:800; letter-spacing:.6px;
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 10px 22px rgba(14,59,70,.25), inset 0 1px 0 rgba(255,255,255,.18);
  cursor:pointer; user-select:none;
  transition:transform .08s ease, filter .2s ease, box-shadow .2s ease;
  position:relative;
}
.pdf-chip svg{width:18px; height:18px; flex:0 0 18px; filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
.pdf-chip:hover{filter:brightness(1.05); box-shadow:0 12px 26px rgba(14,59,70,.35);}
.pdf-chip:active{transform:translateY(1px)}
.pdf-chip::after{
  content:""; position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
  background:radial-gradient(24px 24px at 85% 30%, rgba(255,255,255,.35), transparent 60%);
}

/* المحتوى */
.main{padding:0 10mm; display:flex; flex-direction:column; min-height:0}

/* الجدول */
.table{
  margin-top:var(--gap-top);
  width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; background:#fff;
  border:1px solid var(--line); border-top:4px solid var(--accentDeep);
  box-shadow:0 4px 14px rgba(0,0,0,.05); border-radius:14px; overflow:hidden;
}
.table th,.table td{
  border-right:1px solid var(--line); border-bottom:1px solid var(--line);
  padding:2.4mm 2.6mm;
  vertical-align:middle; text-align:center; font-size:13.4px; line-height:1.35;
  word-break:break-word; overflow-wrap:anywhere;
}
.table td:last-child,.table th:last-child{border-right:0}
.table tr:last-child td,.table tr:last-child th{border-bottom:0}

/* صف العنوان */
.table .title-row th{
  padding:4mm 5mm;
  background:linear-gradient(180deg,rgba(47,127,121,.97),rgba(14,59,70,.98));
  color:#fff; font-weight:800; font-size:var(--title); line-height:1.2; position:relative;
}
.table .title-row th::after{
  content:""; position:absolute; inset-inline:0; bottom:0; height:3px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.28),transparent);
}
.table .title-row [contenteditable]:focus{outline:2px dashed rgba(255,255,255,.85); outline-offset:4px}

/* رؤوس */
.table .label{
  width:23.5%;
  background:linear-gradient(180deg,#f1fafb,#ecf7f8);
  color:#1d6a65; font-weight:800;
}

/* الأهداف والنبذة */
.split{
  margin-top:var(--gap-mid);
  display:grid; grid-template-columns:1fr 1fr; gap:4mm;
  height:66mm;
}
.card{
  border:1px solid var(--line); border-radius:14px; background:#fff;
  display:grid; grid-template-rows:12mm 1fr; overflow:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,.06); position:relative;
}
.card .head{
  padding:0 4mm; display:flex; align-items:center;
  background:linear-gradient(180deg,#f6fbfc,#eef7f8);
  color:#0b7e88; font-weight:800; border-bottom:1px solid var(--line)
}
.card .body{padding:3mm 4mm; overflow:hidden; display:flex; position:relative}
.fittext{width:100%; height:100%; white-space:pre-wrap; word-break:break-word; overflow:hidden; line-height:1.6; font-size:15px}

/* شريط أدوات الكتابة داخل المربع */
.tools{
  position:absolute; top:8px; inset-inline-end:8px; z-index:6;
  display:flex; gap:6px; background:rgba(255,255,255,.85);
  border:1px solid var(--line); border-radius:10px; padding:3px 6px;
  box-shadow:0 4px 12px rgba(0,0,0,.08); backdrop-filter:saturate(140%) blur(4px);
}
.toolbtn{min-width:34px; height:28px; border:1px solid var(--line); background:#fff;
  font-weight:800; font-size:12px; border-radius:8px; cursor:pointer}
.toolbtn:active{transform:scale(.98)}
.card:hover{box-shadow:0 10px 22px rgba(0,0,0,.08)}

/* الشواهد — 4 صور */
.gallery{
  margin-top:var(--gap-gallery);
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
  gap:4mm; height:116mm; margin-top:auto;
}
.photo{
  position:relative; background:#fff; border:1px solid var(--line); border-radius:14px;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
}
.photo input{
  position:absolute; inset:0;
  opacity:0.001;
  cursor:pointer;
  pointer-events:auto;
  z-index:5;
}
.photo .hint, .photo img{ pointer-events:none; }
.photo .hint{
  position:absolute; inset:10px;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
  text-align:center; padding:14px 14px; z-index:2;
  font-size:14.5px; font-weight:900; line-height:1.75; color:#0e3b46;
  background:rgba(255,255,255,.94);
  border:2px dashed rgba(47,127,121,.70);
  border-radius:14px;
  box-shadow:0 10px 24px rgba(0,0,0,.10);
}
.photo .hint .type{
  display:inline-block; padding:6px 12px; border-radius:999px;
  font-weight:1000; letter-spacing:.6px; color:#0e3b46;
  border:1px solid rgba(14,59,70,.28);
  background:linear-gradient(180deg, rgba(47,127,121,.18), rgba(14,59,70,.10));
}
.photo::before{content:""; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg,transparent,rgba(47,127,121,.05)); z-index:1;}
.photo img{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:2; display:block}

/* التواقيع */
.signatures{margin-top:var(--gap-sign); height:22mm; display:grid; grid-template-columns:1fr 1fr; gap:4mm}
.sig{background:#fff; border:1px solid var(--line); border-radius:12px; display:grid; grid-template-rows:9mm 1fr; text-align:center; box-shadow:0 6px 14px rgba(0,0,0,.06)}
.sig h4{margin:0; display:grid; place-items:center; color:#1597a0; font-weight:800; font-size:var(--name); border-bottom:1px solid var(--line)}
.sig .name{display:grid; place-items:center; font-weight:800; font-size:var(--name)}

/* شريط سفلي */
.footer-bar{height:6mm; background:var(--footer)}

/* توافق الشاشات الصغيرة */
@media screen and (max-width:900px){
  body{overflow-x:auto;}
  .sheet{
    transform:scale(.8);
    transform-origin:top center;
    margin:8px auto 16px;
  }
}
@media screen and (max-width:600px){
  .sheet{
    transform:scale(.7);
    transform-origin:top center;
  }
}
@media print{
  .sheet{
    transform:none !important;
    width:210mm;
    height:297mm;
    margin:0;
    box-shadow:none;
    border:none;
  }
  .header-action{display:none !important;}
}
</style>
</head>

<body>

<div class="sheet" id="sheet">
  <!-- الهيدر -->
  <div class="header-img">
    <!-- ✅ الهيدر من الرابط + fallback لو فشل -->
    <img
      id="headerPic"
      src="https://www.raed.net/img?id=1516341"
      data-src-remote="https://www.raed.net/img?id=1516341"
      data-src-local="header.jpg"
      alt="هيدر وزارة التعليم"
      crossOrigin="anonymous"
      referrerpolicy="no-referrer"
    >

    <!-- نص الهيدر وسط فوق بعض (قابل للتعديل) -->
    <div class="header-center">
      <div contenteditable="true">الإدارة العامة للتعليم بـمحافظة جدة</div>
      <div contenteditable="true">قطاع التعليم بـالجنوب</div>
      <div contenteditable="true"> مدرسة عماد الدين زنكي المتوسطة</div>
    </div>

    <!-- زر PDF داخل الهيدر (لا يُطبع) -->
    <div class="header-action" data-nopdf="true">
      <button id="btnPdf" class="pdf-chip" type="button" title="Save as PDF">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Zm0 2.5L19.5 10H14V4.5ZM8.5 14H10a2 2 0 1 0 0-4H8v6h.5v-2Zm1-3.5H10a1 1 0 1 1 0 2H9.5v-2ZM12 16h1.5c1.38 0 2.5-1.12 2.5-2.5S14.88 11 13.5 11H12v5Zm1-4h.5a1.5 1.5 0 0 1 0 3H13v-3Zm-4.5 6H16v1H8.5v-1Z"/>
        </svg>
        الحفظ والطباعة
      </button>
    </div>

    <div class="header-fallback" id="headerFallback"></div>
  </div>

  <div class="main">
    <!-- الجدول -->
    <table class="table" id="infoTable" role="table" aria-label="بيانات البرنامج">
      <tr class="title-row">
        <th colspan="4">
          <div id="reportTitle" contenteditable="true">اسم التقرير</div>
        </th>
      </tr>
      <tr>
        <th class="label" contenteditable="true">مقدّم البرنامج</th>
        <td contenteditable="true">اسم الجهة المنفذة</td>
        <th class="label" contenteditable="true">المكان</th>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <th class="label" contenteditable="true">التاريخ (هجري أم القرى)</th>
        <td id="hijriDate" contenteditable="true"></td>
        <th class="label" contenteditable="true">المستفيدون</th>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <th class="label" contenteditable="true">عدد الحضور</th>
        <td contenteditable="true"></td>
        <th class="label" contenteditable="true">مدة البرنامج</th>
        <td contenteditable="true"></td>
      </tr>
    </table>

    <!-- الأهداف + النبذة -->
    <div class="split">
      <div class="card">
        <div class="head">الأهداف</div>
        <div class="body">
          <div class="tools" data-nopdf="true">
            <button class="toolbtn" onclick="adjText('goals',+1)">+A</button>
            <button class="toolbtn" onclick="adjText('goals',-1)">−A</button>
            <button class="toolbtn" onclick="toggleBold('goals')">B</button>
          </div>
          <div id="goals" class="fittext" contenteditable="true">اكتب الأهداف هنا…</div>
        </div>
      </div>
      <div class="card">
        <div class="head">نبذة عن البرنامج</div>
        <div class="body">
          <div class="tools" data-nopdf="true">
            <button class="toolbtn" onclick="adjText('about',+1)">+A</button>
            <button class="toolbtn" onclick="adjText('about',-1)">−A</button>
            <button class="toolbtn" onclick="toggleBold('about')">B</button>
          </div>
          <div id="about" class="fittext" contenteditable="true">اكتب النبذة هنا…</div>
        </div>
      </div>
    </div>

    <!-- الشواهد -->
    <div class="gallery" id="gallery">
      <div class="photo">
        <input type="file" accept="image/*,.heic,.heif">
        <div class="hint" data-nopdf="true">
          <div>تنبيه مهم: صانع التقارير يعتمد معالجة الصور وتصديرها بصيغة</div>
          <div class="type">JPG / JPEG</div>
          <div>لأفضل وضوح داخل ملف PDF (حتى لو رفعت PNG سيتم تحويلها تلقائيًا).</div>
        </div>
      </div>

      <div class="photo">
        <input type="file" accept="image/*,.heic,.heif">
        <div class="hint" data-nopdf="true">
          <div>تنبيه مهم: صانع التقارير يعتمد معالجة الصور وتصديرها بصيغة</div>
          <div class="type">JPG / JPEG</div>
          <div>لأفضل وضوح داخل ملف PDF (حتى لو رفعت PNG سيتم تحويلها تلقائيًا).</div>
        </div>
      </div>

      <div class="photo">
        <input type="file" accept="image/*,.heic,.heif">
        <div class="hint" data-nopdf="true">
          <div>تنبيه مهم: صانع التقارير يعتمد معالجة الصور وتصديرها بصيغة</div>
          <div class="type">JPG / JPEG</div>
          <div>لأفضل وضوح داخل ملف PDF (حتى لو رفعت PNG سيتم تحويلها تلقائيًا).</div>
        </div>
      </div>

      <div class="photo">
        <input type="file" accept="image/*,.heic,.heif">
        <div class="hint" data-nopdf="true">
          <div>تنبيه مهم: صانع التقارير يعتمد معالجة الصور وتصديرها بصيغة</div>
          <div class="type">JPG / JPEG</div>
          <div>لأفضل وضوح داخل ملف PDF (حتى لو رفعت PNG سيتم تحويلها تلقائيًا).</div>
        </div>
      </div>
    </div>

    <!-- التواقيع -->
    <div class="signatures">
      <div class="sig">
        <h4 contenteditable="true">المعلم</h4>
        <div class="name" contenteditable="true">اسم المعلم</div>
      </div>
      <div class="sig">
        <h4>مدير المدرسة</h4>
        <div class="name" contenteditable="true">عابد عبيد الجدعاني</div>
      </div>
    </div>
  </div>

  <div class="footer-bar" aria-hidden="true"></div>
</div>

<script>
const STORAGE_KEY='report_v15_headerPDF_chip';
function setBusy(b){const el=document.getElementById('btnPdf'); if(el) el.disabled=!!b;}

function fitBox(id){
  const el=document.getElementById(id); if(!el) return;
  const p=el.parentElement; let s=parseFloat(getComputedStyle(el).fontSize)||15;
  const set=v=>{el.style.fontSize=v+'px'; el.style.lineHeight=Math.max(1.25,Math.min(1.6,1.3+(v-12)*0.05));};
  set(s);
  let i=0; while(i++<80 && el.scrollHeight>p.clientHeight && s>12){ s-=.5; set(s); }
  i=0; while(i++<40 && el.scrollHeight<p.clientHeight*.9 && s<20){ s+=.5; set(s); if(el.scrollHeight>p.clientHeight){ s-=.5; set(s); break; } }
}
function adjText(id,dir){
  const el=document.getElementById(id); if(!el) return;
  const cur=parseFloat(getComputedStyle(el).fontSize)||15;
  const next=Math.max(12,Math.min(20,cur+(dir>0?1:-1)));
  el.style.fontSize=next+'px';
  fitBox(id);
}
function toggleBold(id){
  const el=document.getElementById(id); if(!el) return;
  el.style.fontWeight=(getComputedStyle(el).fontWeight>='600')?'400':'700';
  fitBox(id);
}

/* ========= تحويل صورة (قد يفشل مع CORS) ========= */
async function toDataURL(img,{maxSide=2400,q=0.95}={}){
  await (img.decode?.().catch(()=>{}) || new Promise(r=>{
    if(img.complete&&img.naturalWidth) r();
    else { img.addEventListener('load',r,{once:true}); img.addEventListener('error',r,{once:true}); }
  }));
  const w=img.naturalWidth,h=img.naturalHeight;
  const s=Math.min(1,maxSide/Math.max(w,h));
  const cw=Math.max(1,Math.floor(w*s)),ch=Math.max(1,Math.floor(h*s));
  const c=document.createElement('canvas'); c.width=cw; c.height=ch;
  c.getContext('2d',{alpha:false}).drawImage(img,0,0,cw,ch);
  return c.toDataURL('image/jpeg',q);
}

/* ========= Fallback للهيدر (مناسب لGitHub Pages) ========= */
function bindHeaderFallback(){
  const img = document.getElementById('headerPic');
  const fb  = document.getElementById('headerFallback');
  if(!img) return;

  const local = img.getAttribute('data-src-local') || 'header.jpg';

  const showFallback = ()=>{
    if(fb) fb.style.display='block';
    // جرّب المحلي لو موجود
    if(local && img.src !== local){
      img.src = local;
    }
  };

  img.addEventListener('error', showFallback);
  img.addEventListener('load', ()=>{ if(fb) fb.style.display='none'; });

  // حماية إضافية: لو ما اكتمل تحميله خلال 4 ثواني جرّب المحلي
  setTimeout(()=>{
    if(!img.complete || !img.naturalWidth){
      showFallback();
    }
  }, 4000);
}

/* ========= صور المعرض بدون تشوّه + خلفية من الصورة ========= */
async function renderFillNoDistortion(file, box){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    const cleanup = () => { try{ URL.revokeObjectURL(url); }catch{} };

    img.onload = () => {
      try{
        const dpr  = Math.min(window.devicePixelRatio || 1, 2.2);
        const rect = box.getBoundingClientRect();
        const W = Math.max(1, Math.round(rect.width  * dpr));
        const H = Math.max(1, Math.round(rect.height * dpr));

        const c = document.createElement('canvas');
        c.width = W; c.height = H;
        const ctx = c.getContext('2d', { alpha:false });

        ctx.imageSmoothingEnabled = true;
        try{ ctx.imageSmoothingQuality = 'high'; }catch{}

        const iw = img.naturalWidth, ih = img.naturalHeight;
        const rContain = Math.min(W / iw, H / ih);
        const newW = Math.max(1, Math.round(iw * rContain));
        const newH = Math.max(1, Math.round(ih * rContain));
        const x = Math.round((W - newW) / 2);
        const y = Math.round((H - newH) / 2);

        const t = document.createElement('canvas');
        t.width = newW; t.height = newH;
        const tctx = t.getContext('2d', { alpha:false, willReadFrequently:true });
        tctx.imageSmoothingEnabled = true;
        try{ tctx.imageSmoothingQuality = 'high'; }catch{}
        tctx.drawImage(img, 0, 0, newW, newH);

        const cx = Math.max(0, Math.min(newW-1, (newW/2)|0));
        const cy = Math.max(0, Math.min(newH-1, (newH/2)|0));
        const center = tctx.getImageData(cx, cy, 1, 1).data;
        ctx.fillStyle = `rgb(${center[0]},${center[1]},${center[2]})`;
        ctx.fillRect(0,0,W,H);

        const blurPx = 18;
        ctx.filter = `blur(${blurPx}px)`;

        if(x > 0){
          ctx.drawImage(t, 0, 0, 1, newH, 0, y, x, newH);
          ctx.drawImage(t, newW-1, 0, 1, newH, x+newW, y, x, newH);
        }
        if(y > 0){
          ctx.drawImage(t, 0, 0, newW, 1, x, 0, newW, y);
          ctx.drawImage(t, 0, newH-1, newW, 1, x, y+newH, newW, y);
        }
        if(x > 0 && y > 0){
          ctx.drawImage(t, 0, 0, 1, 1, 0, 0, x, y);
          ctx.drawImage(t, newW-1, 0, 1, 1, x+newW, 0, x, y);
          ctx.drawImage(t, 0, newH-1, 1, 1, 0, y+newH, x, y);
          ctx.drawImage(t, newW-1, newH-1, 1, 1, x+newW, y+newH, x, y);
        }

        ctx.filter = 'none';
        ctx.drawImage(t, x, y);

        const out = c.toDataURL('image/jpeg', 0.94);
        cleanup();
        resolve(out);
      }catch(e){
        cleanup(); reject(e);
      }
    };

    img.onerror = () => { cleanup(); reject(new Error('تعذّر قراءة الصورة')); };
    img.src = url;
  });
}

/* ========= دعم HEIC/HEIF ========= */
function getExt(name=""){ const i = name.lastIndexOf('.'); return i >= 0 ? name.slice(i+1).toLowerCase() : ""; }
function isLikelyImage(file){
  const t = (file?.type || "").toLowerCase();
  if (t.startsWith("image/")) return true;
  const e = getExt(file?.name || "");
  return ["jpg","jpeg","png","webp","gif","bmp","tif","tiff","heic","heif","hif","heifs"].includes(e);
}
function isHeicLike(file){
  const t = (file?.type || "").toLowerCase();
  const e = getExt(file?.name || "");
  return t.includes("heic") || t.includes("heif") || ["heic","heif","hif","heifs"].includes(e);
}
async function canBrowserDecode(file, timeoutMs=3500){
  return new Promise((resolve)=>{
    let settled=false, url=null, timer=null;
    const finish=(ok)=>{
      if(settled) return;
      settled=true;
      if(timer) clearTimeout(timer);
      if(url) { try{ URL.revokeObjectURL(url);}catch{} }
      resolve(!!ok);
    };
    try{
      url = URL.createObjectURL(file);
      const img = new Image();
      timer = setTimeout(()=>finish(false), timeoutMs);
      img.onload = ()=>finish(true);
      img.onerror = ()=>finish(false);
      img.src = url;
    }catch{ finish(false); }
  });
}
async function convertHeicToJpeg(file){
  if(typeof window.heic2any !== "function") throw new Error("HEIC converter not loaded");
  const out = await window.heic2any({ blob:file, toType:"image/jpeg", quality:0.95 });
  const blob = Array.isArray(out) ? out[0] : out;
  const base = (file.name || "photo").replace(/\.(heic|heif|hif|heifs)$/i, "");
  const jpgName = base + ".jpg";
  const f = (typeof File === "function")
    ? new File([blob], jpgName, { type:"image/jpeg", lastModified: Date.now() })
    : blob;
  if(typeof File !== "function"){ try{ f.name = jpgName; }catch{} }
  return f;
}
async function normalizeImageFile(file){
  if(!file) return null;
  if(!isLikelyImage(file)) return null;
  if(isHeicLike(file)){
    const ok = await canBrowserDecode(file);
    if(ok) return file;
    return await convertHeicToJpeg(file);
  }
  return file;
}

/* ========= ربط مربعات الصور ========= */
function bindPhotoBox(box){
  const input = box.querySelector('input[type=file]');
  const hint  = box.querySelector('.hint');
  if(!input) return;

  const setImage = (src)=>{
    let img = box.querySelector('img');
    if(!img){
      img = document.createElement('img');
      box.appendChild(img);
    }
    img.src = src;
    hint?.remove();
    save();
  };

  const handleFile = async (rawFile)=>{
    try{
      const file = await normalizeImageFile(rawFile);
      if(!file){ alert('الملف ليس صورة صالحة.'); return; }
      const dataUrl = await renderFillNoDistortion(file, box);
      setImage(dataUrl);
    }catch(err){
      console.error(err);
      alert('تعذّر معالجة الصورة. إذا كانت HEIC/HEIF جرّب تحويلها إلى JPG.');
    }finally{
      input.value = "";
    }
  };

  input.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(f) handleFile(f);
  });

  const onDragOver = (e)=>{ e.preventDefault(); box.style.outline='2px dashed #2f7f79'; };
  const onDragLeave= (e)=>{ e.preventDefault(); box.style.outline='none'; };

  [box, input].forEach(el=>{
    el.addEventListener('dragover', onDragOver);
    el.addEventListener('dragenter', onDragOver);
    el.addEventListener('dragleave', onDragLeave);
    el.addEventListener('drop', onDragLeave);
    el.addEventListener('drop', (e)=>{
      const f = e.dataTransfer?.files?.[0];
      if(f) handleFile(f);
    });
  });

  box.addEventListener('paste', (e)=>{
    const item=[...(e.clipboardData?.items||[])].find(it=>it.type?.startsWith('image/'));
    const f=item?.getAsFile?.();
    if(f) handleFile(f);
  });
}

/* التاريخ الهجري الافتراضي */
(function(){
  try{
    const h=document.getElementById('hijriDate');
    if(h && !h.textContent.trim()){
      h.textContent=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{day:'2-digit',month:'long',year:'numeric'}).format(new Date());
    }
  }catch{}
})();

/* حفظ/استرجاع */
function snap(){
  const cells=[...document.querySelectorAll('#infoTable th,#infoTable td')].map(c=>c.innerHTML);
  const photos=[...document.querySelectorAll('.gallery .photo img')].map(i=>i?.src||'');
  return {
    title:document.getElementById('reportTitle').innerHTML,
    h:document.getElementById('hijriDate').innerHTML,
    g:document.getElementById('goals').innerHTML,
    a:document.getElementById('about').innerHTML,
    cells, photos
  };
}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(snap()));}
(function restore(){
  try{
    const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(!s) return;
    document.getElementById('reportTitle').innerHTML=s.title;
    document.getElementById('hijriDate').innerHTML=s.h;
    document.getElementById('goals').innerHTML=s.g;
    document.getElementById('about').innerHTML=s.a;
    const cells=[...document.querySelectorAll('#infoTable th,#infoTable td')];
    s.cells?.forEach((v,i)=>{ if(cells[i]) cells[i].innerHTML=v; });
    const boxes=[...document.querySelectorAll('.gallery .photo')];
    s.photos?.forEach((src,i)=>{
      if(!src||!boxes[i]) return;
      let img=boxes[i].querySelector('img');
      if(!img){img=document.createElement('img');boxes[i].appendChild(img);}
      img.src=src;
      boxes[i].querySelector('.hint')?.remove();
    });
    ['goals','about'].forEach(fitBox);
  }catch{}
})();

/* ========= PDF ========= */
async function makePdf(){
  // 1) محاولة تثبيت الهيدر: لو كان remote وفشل CORS، الفallback المحلي سينقذك (إن وجد)
  const header = document.getElementById('headerPic');
  if(header){
    try{
      // لو كان من رابط خارجي، نحاول تحويله إلى dataURL (قد ينجح/قد يفشل)
      if(header.src && /^https?:\/\//i.test(header.src)){
        header.crossOrigin = 'anonymous';
        const data = await toDataURL(header).catch(()=>null);
        if(data) header.src = data;
      }
    }catch{}
  }

  // 2) حوّل بقية الصور غير data إلى data (لو أمكن)
  const imgs=[...document.querySelectorAll('#sheet img')];
  for(const im of imgs){
    if(!im.src.startsWith('data:image')){
      try{ im.src=await toDataURL(im); }catch{}
    }
  }

  const canvas=await html2canvas(document.getElementById('sheet'),{
    scale:Math.min(window.devicePixelRatio||2,2.4),
    backgroundColor:'#ffffff',
    useCORS:true,
    allowTaint:false,
    scrollX:0,
    scrollY:-window.scrollY,
    ignoreElements:(el)=>el?.dataset?.nopdf==='true'||el?.tagName==='INPUT'
  });

  const img=canvas.toDataURL('image/jpeg',0.96);
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
  const W=pdf.internal.pageSize.getWidth(),H=pdf.internal.pageSize.getHeight();
  const w=W,h=(canvas.height*W)/canvas.width,fit=h<=H;
  const drawW=fit?w:(canvas.width*H)/canvas.height,drawH=fit?h:H;
  pdf.addImage(img,'JPEG',(W-drawW)/2,(H-drawH)/2,drawW,drawH,'','FAST');

  const title=(document.getElementById('reportTitle').innerText||'Report').replace(/[\\\/:*?"<>|]+/g,' ').trim();
  const hijri=(document.getElementById('hijriDate').innerText||'').replace(/\s+/g,' ').trim();
  pdf.save(`${title} - ${hijri}.pdf`);
}

/* تشغيل */
document.addEventListener('DOMContentLoaded', ()=>{
  bindHeaderFallback();

  ['goals','about'].forEach(id=>{
    const el=document.getElementById(id);
    ['input','keyup','blur'].forEach(evt=> el.addEventListener(evt, ()=>{fitBox(id); save();}));
    fitBox(id);
  });

  document.querySelectorAll('.gallery .photo').forEach(bindPhotoBox);

  document.getElementById('btnPdf')?.addEventListener('click', async ()=>{
    try{ setBusy(true); save(); await makePdf(); }
    catch(e){ console.error(e); alert('تعذّر إنشاء PDF.'); }
    finally{ setBusy(false); }
  });
});
</script>
</body>
</html>